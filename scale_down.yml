- name: Approve csr
  hosts: bastion
  vars_files:
    - vars/main.yml
  vars:
    # nodename: "{{  morpheus['customOptions']['nodename'] }}"
    # kubeconfig: "{{ morpheus['customOptions']['kubeconfig'] }}"
    nodename: 'ocp4-compute-3.lab.ocp.local'
    kubeconfig: '/root/lab/install-dir/auth/kubeconfig'
  tasks:
    - name: oc adm cordon 
      ansible.builtin.command: 
        cmd: "oc adm cordon {{ nodename }}"
      environment: 
        KUBECONFIG: "{{ kubeconfig }}"
      register: output

    - debug: 
        var: output 
    
    - name: oc adm drain
      ansible.builtin.command:
        cmd: "oc adm drain  {{ nodename }} --ignore-daemonsets --delete-emptydir-data"
      environment: 
        KUBECONFIG: "{{ kubeconfig }}"
          # /home/itopr/ocppl/auth/kubeconfig
      register: output

    - name: oc delete node
      ansible.builtin.command:
        cmd: "oc delete node {{ nodename }}"   
      environment: 
        KUBECONFIG: "{{ kubeconfig }}"
          # /home/itopr/ocppl/auth/kubeconfig
      register: output

    - name: Power-Off the openshift VMs
      vmware_guest:
        hostname: "{{ vcenter.host }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        datacenter: "{{ vcenter.datacenter }}"
        validate_certs: no
        folder: "{{ vcenter.folder }}"
        name: "{{  nodename }}"
        state: poweredoff
       
    
    - name: Delete openshift VM
      vmware_guest:
        hostname: "{{ vcenter.host }}"
        username: "{{ vcenter.username }}"
        password: "{{ vcenter.password }}"
        datacenter: "{{ vcenter.datacenter }}"
        validate_certs: no
        folder: "{{ vcenter.folder }}"
        name: "{{  nodename }}"
        state: absent
  
